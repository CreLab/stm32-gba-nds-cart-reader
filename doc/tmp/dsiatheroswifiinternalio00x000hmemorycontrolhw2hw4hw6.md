# DSi Atheros Wifi - Internal I/O - 00x000h - Memory Control (hw2/hw4/hw6)


### TCAM/BCAM (Ternary/Binary Content Addressable Memory) (ROM Patches)
TCAM/BCAM registers are allowing to patch ROM (in a similar fashion as Game Genie cheat devices). The ROM patches can be initialized via BMI commands:
- [DSi Atheros Wifi - BMI Bootloader Commands](./dsiatheroswifibmibootloadercommands.md)
Many ROM functions are called via a Table in RAM, which can be patched without needing the TCAM/BCAM feature (actually, the DSi\'s AR6002 firmware is patching only three of that RAM Table entries, and leaves the TCAM feature completely unused).


```
+---------------------------------------------------------------------------+
|      ______________________ hw2 ROM Patches (TCAM) ______________________ |
+---------------------------------------------------------------------------+
```


### ATH:008000h..807Ch - (WLAN\_)MC_TCAM_VALID\[0..31\] ;hw2

```
+-----------------------------------------------------------------------+
|       0      BIT    (?=Patch Enable)                                  |
+-----------------------------------------------------------------------+
```


### ATH:008080h..80FCh - (WLAN\_)MC_TCAM_MASK\[0..31\] ;hw2

```
+----------------------------------------------------------------------------+
|       0-2    SIZE   (... patch area, selectable 32-bytes or bigger or so?) |
+----------------------------------------------------------------------------+
```

The eight size settings are probably 20h,40h,80h,100h,200h,400h,800h,1000h.

### ATH:008100h..817Ch - (WLAN\_)MC_TCAM_COMPARE\[0..31\] ;hw2

```
+-------------------------------------------------------------------------------------+
|       5-21   KEY    (Patch ROM Address in 32-byte steps) (probably 0E0000h and up?) |
+-------------------------------------------------------------------------------------+
```


### ATH:008180h..81FCh - (WLAN\_)MC_TCAM_TARGET\[0..31\] ;hw2

```
+-------------------------------------------------------------------------------------+
|       5-21   ADDR   (Patch RAM Address in 32-byte steps) (probably 100000h and up?) |
+-------------------------------------------------------------------------------------+
```



```
+---------------------------------------------------------------------------+
|      ______________________ hw4 ROM Patches (BCAM) ______________________ |
+---------------------------------------------------------------------------+
```


The hw4 ROM patching is done in 32bit Data units, but 16bit/24bit Xtensa opcodes aren\'t neccessarily 32bit aligned, so one may need 1-2 patch slots per opcode.

### ATH:008000h..0081FCh - WLAN_MC_BCAM_VALID\[0..127\] ;hw4

```
+-----------------------------------------------------------------------+
|       0      BIT    some "bit" (128 x 1bit)    (?=Patch Enable)       |
|       1-31   -                                                        |
+-----------------------------------------------------------------------+
```


### ATH:008200h..0083FCh - WLAN_MC_BCAM_COMPARE\[0..127\] ;hw4

```
+--------------------------------------------------------------------------------+
|       0-1    -                                                                 |
|       2-19   KEY    some "key" (128 x 18bit)   (Patch Address in 4-byte steps) |
|       20-31  -                                                                 |
+--------------------------------------------------------------------------------+
```


### ATH:008400h..0085FCh - WLAN_MC_BCAM_TARGET\[0..127\] ;hw4

```
+-----------------------------------------------------------------------+
|       0-31   INST   some "inst" (128 x 32bit)  (Patch Data)           |
+-----------------------------------------------------------------------+
```


### ATH:008610h - WLAN_BCAM_CONFLICT_ERROR ;hw4

```
+-----------------------------------------------------------------------+
|       0      DPORT_FLAG                                               |
|       1      IPORT_FLAG                                               |
|       2-31   -                                                        |
+-----------------------------------------------------------------------+
```



```
+--------------------------------------------------------------------------+
|      _______________________ hw6 ROM Patches (?) _______________________ |
+--------------------------------------------------------------------------+
```


Unknown if or how ROM Patches are supported on hw6 (the hw6 source code doesn\'t define any TCAM/BCAM registers).


```
+-------------------------------------------------------------------------+
|      ______________________ ADDR_ERROR Registers ______________________ |
+-------------------------------------------------------------------------+
```


### ATH:008200h - (WLAN\_)ADDR_ERROR_CONTROL ;hw2
### ATH:008600h - WLAN_APB_ADDR_ERROR_CONTROL ;hw4
### ATH:010018h - WLAN_APB_ADDR_ERROR_CONTROL ;hw6

```
+-----------------------------------------------------------------------+
|       0      ENABLE                                                   |
|       1      QUAL_ENABLE                                              |
|       2-31   -                                                        |
+-----------------------------------------------------------------------+
```


### ATH:008204h - (WLAN\_)ADDR_ERROR_STATUS ;hw2
### ATH:008604h - WLAN_APB_ADDR_ERROR_STATUS ;hw4
### ATH:01001Ch - WLAN_APB_ADDR_ERROR_STATUS ;hw6

```
+-----------------------------------------------------------------------+
|       0-24   ADDRESS                                                  |
|       25     WRITE                                                    |
|       26-31  -                                                        |
+-----------------------------------------------------------------------+
```


### ATH:008608h - WLAN_AHB_ADDR_ERROR_CONTROL ;hw4
### ATH:010020h - WLAN_AHB_ADDR_ERROR_CONTROL ;hw6

```
+-----------------------------------------------------------------------+
|       0      ENABLE                                                   |
|       1-31   -                                                        |
+-----------------------------------------------------------------------+
```


### ATH:00860Ch - WLAN_AHB_ADDR_ERROR_STATUS ;hw4
### ATH:010024h - WLAN_AHB_ADDR_ERROR_STATUS ;hw6

```
+-----------------------------------------------------------------------+
|       0-23   ADDRESS                                                  |
|       24-29  -                                                        |
|       30     MBOX                                                     |
|       31     MAC                                                      |
+-----------------------------------------------------------------------+
```



```
+-----------------------------------------------------------------------+
|      ______________________ hw4 MISC Registers ______________________ |
+-----------------------------------------------------------------------+
```


### ATH:008614h - WLAN_CPU_PERF_CNT ;hw4

```
+-----------------------------------------------------------------------+
|       0      EN                                                       |
|       1-31   -                                                        |
+-----------------------------------------------------------------------+
```


### ATH:008618h - WLAN_CPU_INST_FETCH ;hw4
### ATH:00861Ch - WLAN_CPU_DATA_FETCH ;hw4

```
+-----------------------------------------------------------------------+
|       0-31   CNT                                                      |
+-----------------------------------------------------------------------+
```


### ATH:008620h - WLAN_CPU_RAM1_CONFLICT ;hw4
### ATH:008624h - WLAN_CPU_RAM2_CONFLICT ;hw4
### ATH:008628h - WLAN_CPU_RAM3_CONFLICT ;hw4
### ATH:00862Ch - WLAN_CPU_RAM4_CONFLICT ;hw4

```
+-----------------------------------------------------------------------+
|       0-11   CNT                                                      |
|       12-31  -                                                        |
+-----------------------------------------------------------------------+
```



```
+-----------------------------------------------------------------------+
|      ______________________ hw6 MISC Registers ______________________ |
+-----------------------------------------------------------------------+
```


### ATH:010028h - WLAN_AHB_CONFIG ;hw6

```
+-----------------------------------------------------------------------+
|       0      MAX_BURST_4                                              |
|       1      MAX_BURST_8                                              |
|       2      MAX_BURST_16                                             |
+-----------------------------------------------------------------------+
```


### ATH:01002Ch - WLAN_MEMORY_MAP ;hw6

```
+-----------------------------------------------------------------------+
|       0      ONE_IRAM_BANK                                            |
|       1      TWO_IRAM_BANKS                                           |
|       2      THREE_IRAM_BANKS                                         |
|       3      FOUR_IRAM_BANKS                                          |
+-----------------------------------------------------------------------+
```



```
+-----------------------------------------------------------------------+
|      ______________________ Xtensa CPU ______________________         |
+-----------------------------------------------------------------------+
```


### Xtensa Region/MMU (hw2)
The Xtensa CPU is additionally having a Region/MMU unit with ITLB and DTLB. The AR6002 ROM is doing some basic initialization via mmu-opcodes:

```
+-----------------------------------------------------------------------+
|       set ITLB[(0..7)*20000000h] to values (1,2,2,2,2,2,2,2)          |
|       set DTLB[(0..7)*20000000h] to values (1,2,2,2,2,2,2,2)          |
+-----------------------------------------------------------------------+
```

Alongsides, it\'s issuing an \"isync\" opcode after setting the first ITLB entry, and a \"dsync\" opcode after setting the last DTLB entry. After that initialization, the ROM and Firmware aren\'t using any further mmu-opcodes.



