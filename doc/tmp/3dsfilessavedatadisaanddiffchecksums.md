# 3DS Files - Savedata DISA and DIFF - Checksums


**AES CMAC**
The AES CMAC is located at the beginning of the DISA / DIFF image, and
it is 10h long. The rest F0h bytes before the header are unused.
The key used for the AES CMAC is generated by the hardware key engine.
The data being authenticated by the AES CMAC is a 20h-byte SHA-256 hash
of a data block.

```
+-----------------------------------------------------------------------+
|                                                                       |
|     CTR-NOR0 This CMAC type is used for gamecard savegames, 28h-bytes |
|                                                                       |
|       000h 8    ID "CTR-NOR0"                             ;\CMAC area 
|         008h 20h  SHA-256 of the following 108h-byte block  ;/        |
|         028h 8    ID "CTR-SAV0"                                       |
|         030h 100h Copy of the DISA header                             |
|       CTR-SIGN This CMAC type is used for SD savegames, 30h-bytes     |
|         000h 8    ID "CTR-SIGN"                             ;\        
|                                                                       |
|       008h 8    Title ID                                  ; CMAC area |
|         010h 20h  SHA-256 of the following 108h-byte block  ;/        |
|         030h 8    ID "CTR-SAV0"                                       |
|         038h 100h Copy of the DISA header                             |
|                                                                       |
|      CTR-SYS0 This CMAC type is used for NAND system save, 110h-bytes |
|         000h 8    ID "CTR-SYS0"                                       |
|         008h 8    Save ID. The higher word is always zero             |
|         010h 100h Copy of the DISA header                             |
|       CTR-EXT0 This CMAC type is used for extdata, 11Ch-bytes         |
|         000h 8    ID "CTR-EXT0"                                       |
|                                                                       |
|        008h 8    Extdata ID                eg. "00048000\x00000xx\" ? 
|         010h 4    0 for Quota.dat, 1 otherwise                        |
|         014h                                                          |
| 4    ID in the "device" file name  "\00000000\nnnnnnnn" ?  ;\zero for 
|         018h 4                                                        |
|     ID in the "device" directory name that the file is in ;/Quota.dat |
|         01Ch 100h Copy of the DIFF header                             |
|       CTR-9DB0 This CMAC type is used for title database, 10Ch-bytes  |
|         000h 8    ID "CTR-9DB0"                                       |
|         008h 4    Database .db file ID (0..5, see below)              |
|         00Ch 100h Copy of the DIFF header                             |
|         The Database .db file IDs are:                                |
|         0=t                                                           |
| icket.db, 1=certs.db, 2=title.db, 3=import.db, 4=tmp_t.db, 5=tmp_i.db |
+-----------------------------------------------------------------------+
```

Here is a summary table of the CMAC type and the AES key slot used:

```
+-----------------------------------------------------------------------+
|       Usage           Media    Format  CMAC type       CMAC Keyslot   |
|       Savegames       Gamecard DISA    CTR-NOR0        19h/33h        |
|       Savegames       SD       DISA    CTR-SIGN        30h            |
|       System SaveData NAND     DISA    CTR-SYS0        30h            |
|       Private Extdata SD       DIFF    CTR-EXT0        30h            |
|       Shared Extdata  NAND     DIFF    CTR-EXT0        30h            |
|       Title Database  SD       DIFF    CTR-9DB0        30h            |
|       Title Database  NAND     DIFF    CTR-9DB0        0Bh            |
+-----------------------------------------------------------------------+
```

Note: The AES keyslots are known (shown above), but the AES IV appears
to be unknown?

**IVFC tree**
The IVFC tree is used for data verification. It is very similar to the
IVFC tree in RomFS, except that it has an additional level here. For
level 4, 5 and 6, each level is a list of SHA-256 hash, of which each
corresponds to a block of the next level which is zero-padded to align
the block size (the block size of the next level is defined in the IVFC
descriptor).

The partition master hash in the partition descriptor can be seen as
IVFC level 0, which hashes level 4 following the same rule. The master
hash is usually 20h long, consisting only one hash. This is because most
DISA / DIFF files are not large enough to have multiple hashes on the
top level, which isn\'t the case for some title database files.

However, not all data is hashed - only ranges that have been written
with valid data are properly hashed.

Level 7 is the actual content of the partition, which is what the
container format essentially contains.

**IVFC Chain of trust**
AES CMAC verifies the header.
The header verifies the active partition table via the table hash.
In the partition table, each descriptor verifies level 4 of its IVFC
tree via the master hash.
Each IVFC level verifies the next level, until the level 7, which is the
inner content (eg. the SAVE file system).



