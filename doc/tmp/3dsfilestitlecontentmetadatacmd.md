# 3DS Files - Title Content Metadata (CMD)


**Content Metadata (.cmd) file format**

```
+-----------------------------------------------------------------------+
|                                                                       |
|   00h     4    File number for 000000nn.cmd file (eg. 3=00000003.cmd) |
|       04h     4    Number of Contents (N)                             |
|       08h     4    Number of Contents (N) (same as above)             |
|                                                                       |
|  0Ch     4h   Zerofilled  ;reportedly always 1  ;\maybe shop titles?? 
|       1                                                               |
| 0h     10h  Zerofilled  ;reportedly AES-MAC   ;/or SD card exports??? |
|       20h     N*4  List of file numbers for 000000nn.app files        |
|       20h                                                             |
| +N*4 N*4  List of file numbers for 000000nn.app files (same as above) |
|       20h+N*8 -    Nothing     ;reportedly more AES-MAC's ???         |
+-----------------------------------------------------------------------+
```

The .cmd file is reportedly \"encrypted with a console uniqu
keyslot\"??? (actually, it isn\'t encrypted at all, at least not o
eMMC).

\"\<ContentID\>.cmd\" - (The Content ID is a u32, initially: 0000000
when the title is first installed. Changing by an increment of +0x1 for
each time the 3DS adds/removes \'.app\' files) This file contains dat
taken from the title\'s TMD. See the below table for the format of th
cleartext .cmd file. The Title.db contains the Content ID for the
\'.cmd\' file, but does not contain a hash of the \'.cmd\' file. Thi
acts as part of the DRM for installed titles, along with the title.db.

The below AES-CMACs (including the last 0x10-bytes of the header) are
only used for SD titles, for NAND download-play titles, and non-system
DSiWare titles. For other titles, these MACs are set to all-zero.

```
+-----------------------------------------------------------------------+
|       000                                                             |
| h 4      .cmd ContentID, for the .cmd filename. This is the beginning |
|                     of the header   ;uh, which header? what for?      |
|       0                                                               |
| 04h 4      Number of AES-CMACs and Content IDs in the first list (X). |
|                     The method to determine this is explained below.  |
|       008h 4      Number of Content IDs in the second list (Y)        |
|       00Ch 4      Unknown, usually (always?) 1.                       |
|       010h 10h    AES-CMAC over first 0x10                            |
|       020h                                                            |
|  4*X    List of installed Content IDs in order of Content Index, with |
|                     missing contents replaced with 0xFFFFFFFF         |
|       0                                                               |
| 20h+4*X     4*Y     List of installed Content IDs in order of ID name |
|       020h+4*                                                         |
| (X+Y) 10h*X   AES-CMACs for each content in the first list, generated |
|                              using the process below                  |
+-----------------------------------------------------------------------+
```

The number of AES-CMACs depends on the highest Content Index installed.
For example, a title with 5 contents, but only 1 and 3 are installed,
will still result in 3 AES-CMACs, with the 2nd one being unused.

For SD contents, each AES-CMAC is generated by combining the NCCH header
without the signature (0x100-0x1FF), the Content Index and Content ID at
the end, both as u32. Then calculate the SHA256 of the data and generate
the AES-CMAC using the SD/NAND AES-CMAC key.

For TWLNAND contents, the same process is used (even for SRL contents)
with the keyslot for NAND dbs.




