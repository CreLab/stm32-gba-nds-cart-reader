# 3DS Files - DSiWare Exports


DSiware titles can be exported to SD card. There are many changed details about headers and encryption, but the overall file format quite similar as on real DSi:
- [DSi SD/MMC DSiware Files on External SD Card (.bin aka Tad Files)](./dsisdmmcdsiwarefilesonexternalsdcardbinakatadfiles.md)
As on DSi, the weird encryption makes it impossible to execute the file from SD card (so it must be imported back to eMMC before execution).
Unlike DSi, the 3DS files have all (?) blocks encrypted with console unique keys (making it impossible to decrypt them without having the console\'s movable.sed file).

The 3DS has no (exportable) DSi titles pre-installed, so one would need to register a 3DS shop account before examining the file format.
Below is based on descriptions from 3dbrew (most of it being a bit nebulous).

### DSiWare Export Types (uh, who or what selects which type to use?)

```
+-----------------------------------------------------------------------------------+
|       Type    Format  Description                                                 |
|       0-6     v2?     Same as value 14    (with type 1 being the default?)        |
|       7-11    v2      12 content sections (uh, can header have 12 contents?)      |
|       12      v2      4 content sections  (uh, but v2 header has 11 contents?)    |
|       13      v1 (!)  4 content sections  (what is using this v1 version?)        |
|       14      v2      11 content sections (same as type 1, which is the default?) |
+-----------------------------------------------------------------------------------+
```

For NATIVE_FIRM versions where this DSiWare export type field (in AM:ExportTwlBackup) is unused, format version v1 is used with 4 content sections. Otherwise when this field is used, see the above table.
System Settings uses type 1 for exporting DSiWare, regardless of the System Settings title-version (uh, who or what uses other types?) (uh, is the \"title-version\" relevant for anything else at all?).

### SD:\\Nintendo 3DS\\\<ID0\>\\\<ID1\>\\Nintendo DSiWare\\4GGGGGGG.bin

```
+----------------------------------------------------------------------------+
|       000000h 4000h+20h    Banner section                                  |
|       004020h A0h/F0h+20h  Header section (A0h+20h bytes or F0h+20h bytes) |
|       004xx0h X+340h+20h   Cert section (N*20h+340h+20h bytes)             |
|       004xx0h ???h+20h     000000xx.tmd (usually B34h+20h bytes? padded?)  |
|       004xxxh size+1?*20h  000000vv.app (the NDS/DSi ROM-image)            |
|       ...     0 (?)        seven N/A parts (unknown if/when they are used) |
|       ...     size+1?*20h  public.sav   (if any)                           |
|       ...     ?            banner.sav   (if any)                           |
|       ...     size+1?*20h  private.sav  (if any, type 7-11 only?)          |
+----------------------------------------------------------------------------+
```

Each of the above section contails encrypted data with 20h-byte footers:
DSiWare exported from 3DS use console-unique keyslot(s???) initialized by movable.sed. Each section is encrypted with AES-CBC.

```
+-------------------------------------------------------------------------------+
|       000h  N     Encrypted Data (AES-CBC, (IV=what?, keyslot=what?)          |
|       N+00h 10h   AES MAC across SHA256(Decrypted Data) (CBC-MAC? or CMAC?)   |
|       N+10h 10h   AES IV, generated by the RNG (for decrypt? or for AES MAC?) |
+-------------------------------------------------------------------------------+
```

The encryption with 20h-byte footers is somewhat similar to \"DSi ES Block Encryption\", but CBC/MAC/SHA/IV are all different (and without splitting larger blocks into 128Kbyte blocks?).
Empty blocks with 0-byte size are probably(?) completely omitted (without storing any 20h-byte footers.

### Decrypted Banner (at 0000h, size 4000h)
This is reportedly the \"banner section\", unknown what that means, probably the DSi Icon/Title(?), which would be as so\...

```
+-----------------------------------------------------------------------------+
|       0000h 23C0h  Icon/Title (usually 23C0h bytes) ;see carthdr[068h,208h] |
|       23C0h 1C40h  Zerofilled (padding to get 4000h byte size)              |
+-----------------------------------------------------------------------------+
```


### Decrypted Header block (at 4020h, size A0h or F0h)
There seem to be at least two versions, depending on the Export Type (whatever that is).

```
+-----------------------------------------------------------------------------+
|       v1   v2   Siz Description                                             |
|       000h 000h 4   ID "3FDT"                                               |
|       004h 004h 2   Byte-swapped groupID from the TWL TMD                   |
|       006h 006h 2   Byte-swapped title version from the TWL TMD             |
|       008h 008h 20h SHA256 across encrypted "movable.sed" file              |
|       028h 028h 10h AES-CBC encrypted zeroes with IV=zero using keyslot 0Ah |
|       038h 038h 8   Byte-swapped titleID from the TWL TMD                   |
|       040h 040h 8   ?                                                       |
|       048h 048h 4   Size of TMD   (+20h?)            ?                      |
|       04Ch 04Ch 4   Size of Content 0 ,app ROM-image ?                      |
|       -    050h 4   Size of Content 1 if any         ?                      |
|       -    054h 4   Size of Content 2 if any         ?                      |
|       -    058h 4   Size of Content 3 if any         ?                      |
|       -    05Ch 4   Size of Content 4 if any         ?                      |
|       -    060h 4   Size of Content 5 if any         ?                      |
|       -    064h 4   Size of Content 6 if any         ?                      |
|       -    068h 4   Size of Content 7 if any         ?                      |
|       050h 06Ch 4   Size of public.sav               ?                      |
|       054h 070h 4   Size of banner.sav               ?                      |
|       -    ?    ?   Size of private.sav             ??                      |
|       -    074h 30h ?                                                       |
|       058h -    4   ?                                                       |
|       05Ch 0A4h 3Eh Data from the TWL TMD reserved section. Only the first  |
|                      0x20-bytes from the TWL TMD is written here, the rest  |
|                      is uninitialized.                                      |
|                      Uh, what is a "TWL TMD reserved section"?              |
|       09Ah 0E2h ..  Padding to 10h-byte size                                |
+-----------------------------------------------------------------------------+
```


### Decrypted Cert
There seem to be at least two versions, depending on the Export Type (whatever that is). Non-existing sections are said to have uninitialized SHA entries. And the number if SHA entries is also said to be variable.
Guess:
If the Header has fewer Size entries then the Cert also has fewer SHA entries.
If the Header has entries with Size=0 then the Cert has uninitialized SHAs.

```
+-------------------------------------------------------------------------------+
|       Offset  Size    Description                                             |
|       000h    20h     SHA256(Decrypted Data) for Banner                       |
|       010h    20h     SHA256(Decrypted Data) for Header                       |
|       020h    20h     SHA256(Decrypted Data) for Cert             ?           |
|       030h    20h     SHA256(Decrypted Data) for TMD              ?           |
|       040h    20h     SHA256(Decrypted Data) for Content 0 (.app) ?           |
|       050h   (20h)    SHA256(Decrypted Data) for Content 1    ?????           |
|       060h   (20h)    SHA256(Decrypted Data) for Content 2    ?????           |
|       070h   (20h)    SHA256(Decrypted Data) for Content 3    ?????           |
|       080h   (20h)    SHA256(Decrypted Data) for Content 4    ?????           |
|       090h   (20h)    SHA256(Decrypted Data) for Content 5    ?????           |
|       0A0h   (20h)    SHA256(Decrypted Data) for Content 6    ?????           |
|       0B0h   (20h)    SHA256(Decrypted Data) for Content 7    ?????           |
|       0C0h    20h     SHA256(Decrypted Data) for public.sav       ?           |
|       0D0h    20h     SHA256(Decrypted Data) for banner.sav       ?           |
|       0E0h   (20h)    SHA256(Decrypted Data) for private.sav  ?????           |
|       000h+X  3Ch     ECDSA-SHA256 across above SHAs, signed by APCert        |
|       03Ch+X  180h    ECDSA APCert "APxxxxxxxxxxxxxxxx" cert signed by CTCert |
|                         x is random lowercase ASCII hex data                  |
|       1BCh+X  180h    ECDSA CTCert                                            |
|       33Ch+X  4       Uninitialized padding                                   |
+-------------------------------------------------------------------------------+
```

The curve sect233r1 is used for all related ECDSA signing operations.

### Decrypted TMD
The DSiware Exports are probably containing 3DS-style B34h-byte TMDs (unlike original DSi-style 208h-byte TMDs).
Unknown if the size is padded to 10h-byte boundary.

### Content 1-7
Unknown if these are used (on DSi they are empty), but MAYBE some DSiware titles are shipped with e-Manuals or other stuff on 3DS.

### Note
Config BlkID=00100003h is reportedly used for DSiWare exports (unknown how/where that is used).

### AES-MAC \... or AES-CBC-MAC (with (xtra-)len=?) \... or AES-CMAC ?
Keyslot 3Ah is reportedly used for \"for calculating AES-CMACs for SD DSiWare_Exports\"

### Other files
System Settings ExtData does reportedly contain a MsetExt.dat file for DSiWare Exports Management (similar to HNB\_.lst on DSi). That, in SD Extdata:
- [3DS Files - Savedata Extdata](./3dsfilessavedataextdata.md)
Tickets are probably kept on the console\'s internal eMMC memory.



